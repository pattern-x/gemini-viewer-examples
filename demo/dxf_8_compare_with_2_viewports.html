<html>
  <head>
    <link rel="icon" href="./demo/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./demo/global.css" />
    <link rel="stylesheet" type="text/css" href="./demo/iconfont/iconfont.css" />
    <link rel="stylesheet" href="./demo/compare/dxfComparePanel.css" />
    <link rel="stylesheet" href="./demo/layerManager/layerManager.css" />
    <link rel="stylesheet" href="./demo/settings/SettingsPanel.css" />
    <style>
      body {
        font-size: 0;
      }
      #myCanvas1,
      #myCanvas2 {
        width: calc(50% - 1px);
        height: 100%;
        margin: 0;
        padding: 0;
        display: inline-block;
      }
      .split {
        display: inline-block;
        width: 1px;
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #eee;
      }

      #syncCamera {
        position: absolute;
        text-align: center;
        top: 20px;
        left: calc(50% - 40px);
        height: 40px;
        width: 80px;
        font-size: 16px;
        line-height: 40px;
        color: #fff;
        border-radius: 5px;
        border: 1px solid #409eff;
        background-color: #409eff;
        font-family: inherit;
        cursor: pointer;
        margin: 5px auto;
      }
    </style>
  </head>

  <body>
    <div id="app" class="app">
      <div id="myCanvas1" class="container"></div>
      <div class="split"></div>
      <div id="myCanvas2" class="container"></div>
    </div>
    <button id="syncCamera" title="Click to sync or unsync cameras">unsynced</button>

    <script type="module">
      import {
          AxisGizmoPlugin,
          DxfCompareHelper,
          DxfViewer,
          MeasurementPlugin,
          ToolbarMenuId,
          ViewerEvent,
      } from "./demo/libs/gemini-viewer.esm.min.js";
      import DxfComparePanel from "./demo/compare/dxfComparePanel.js";
      import DxfSettingsPanel from "./demo/settings/DxfSettingsPanel.js";
      import LayerManager from "./demo/layerManager/LayerManager.js";

      const url1 = "./demo/models/dxf/doors_and_windows.dxf";
      const url2 = "./demo/models/dxf/doors_and_windows_mopdified.dxf";
      const compareHelper = new DxfCompareHelper(
        {
          containerId: "myCanvas1",
          enableToolbar: true,
          enableSelection: true,
        },
        {
          containerId: "myCanvas2",
          enableToolbar: true,
          enableSelection: false,
        }
      );
      window.compareHelper = compareHelper;
      const fontFiles = ["./demo/three/fonts/hztxt.shx", "./demo/three/fonts/simplex.shx"];
      await compareHelper.setFont(fontFiles);

      new AxisGizmoPlugin(compareHelper.viewer, { ignoreZAxis: true });
      new MeasurementPlugin(compareHelper.viewer);
      new AxisGizmoPlugin(compareHelper.viewer2, { ignoreZAxis: true });
      new MeasurementPlugin(compareHelper.viewer2);

      compareHelper.viewer.toolbar?.updateMenus(overrideToolbarConfig(compareHelper.viewer));
      compareHelper.viewer2.toolbar?.updateMenus(overrideToolbarConfig(compareHelper.viewer2));

      const syncCameraBtn = document.getElementById("syncCamera");
      let enableSyncCamera = false;
      syncCameraBtn.onclick = function () {
        if (!enableSyncCamera) {
          compareHelper.enableSyncCamera(true);
          syncCameraBtn.innerText = "synced";
        } else {
          compareHelper.enableSyncCamera(false);
          syncCameraBtn.innerText = "unsynced";
        }
        enableSyncCamera = !enableSyncCamera;
      };

      const onProgress = (event) => {
        const progress = ((event.loaded * 100) / event.total).toFixed(2);
        console.log(`[Demo] Compare progress: ${progress}%`);
      };

      // compare two specific dxf by default
      compareHelper.compare({ src: url1, modelId: "dxf_3" }, { src: url2, modelId: "dxf_3_1" }, undefined, onProgress).then(() => {
        console.log(`[Demo] Compared models: ${url1}, ${url2}`);
        new DxfComparePanel(compareHelper, compareHelper.container);
      }).catch((reason) => {
        console.error(`[Demo] Failed to compare models: ${url1}, ${url2}. reason: ${reason}`);
      });

      function overrideToolbarConfig(viewer) {
        return [
          {
            menuId: ToolbarMenuId.Settings,
            config: {
              onActive: () => {
                console.log("[Toolbar]", "Activate Settings");
                if (!viewer.dxfSettingsPanel) {
                  viewer.dxfSettingsPanel = new DxfSettingsPanel(viewer);
                }
                viewer.dxfSettingsPanel.show();
              },
              onDeactive: () => {
                console.log("[Toolbar]", "Deactivate Settings");
                if (!viewer.dxfSettingsPanel) {
                  viewer.dxfSettingsPanel = new DxfSettingsPanel(viewer);
                }
                viewer.dxfSettingsPanel.hide();
              },
            },
          },
          {
            menuId: ToolbarMenuId.Layers,
            config: {
              onActive: () => {
                console.log("[Toolbar]", "Activate Layers");
                if (!viewer.layerManager) {
                  viewer.layerManager = new LayerManager(viewer);
                }
                viewer.layerManager.show();
              },
              onDeactive: () => {
                console.log("[Toolbar]", "Deactivate Layers");
                if (!viewer.layerManager) {
                  viewer.layerManager = new LayerManager(viewer);
                }
                viewer.layerManager.hide();
              },
            },
          },
          {
            menuId: ToolbarMenuId.MarkupVisibility,
            config: {
              visible: false,
            },
          },
          {
            menuId: ToolbarMenuId.Fullscreen,
            config: {
              onClick: (bimViewer, toolbar) => {
                const isFullScreen = !!document.fullscreenElement;
                const onResize = () => {
                  const toolbarMenu = toolbar?.menuList.get(
                    ToolbarMenuId.Fullscreen
                  );
                  toolbarMenu && toolbarMenu.setActive(isFullScreen);
                };

                if (isFullScreen) {
                  document.exitFullscreen();
                  window.removeEventListener("resize", onResize);
                } else {
                  compareHelper.container.requestFullscreen();
                }
                window.addEventListener("resize", onResize);
              },
            },
          },
        ];
      }
    </script>
  </body>
</html>

