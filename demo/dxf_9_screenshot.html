<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="
		width=device-width,
		initial-scale=1.0,
		minimum-scale=1.0,
		maximum-scale=1.0,
		user-scalable=no"
    />
    <link rel="icon" href="./demo/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./demo/global.css" />
    <link rel="stylesheet" type="text/css" href="./demo/iconfont/iconfont.css"/>
    <link rel="stylesheet" href="./demo/settings/SettingsPanel.css" />
    <style>
      #myCanvas {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div id="myCanvas" class="container"></div>
    </div>
    <script type="module">
      import {
          AxisGizmoPlugin,
          DxfViewer,
          LayerManagerPlugin,
          MeasurementPlugin,
          MenuTypeEnums,
          ScreenshotMode,
          ToolbarMenuId,
          ViewerEvent,
      } from "./demo/libs/gemini-viewer.esm.min.js";
      import DxfSettingsPanel from "./demo/settings/DxfSettingsPanel.js";

      const filename = "rac_basic_sample_project";
      const modelCfg = {
        modelId: filename,
        name: filename,
        src: `./demo/models/dxf/${filename}.dxf`,
        merge: true,
      };
      const config = {
        containerId: "myCanvas",
        enableToolbar: true,
        enableSpinner: true,
        enableProgressBar: true,
        enableLayoutBar: true,
        toolbarMenuConfig: {
          [ToolbarMenuId.Settings]: {
            onActive: () => {
              console.log("[Toolbar]", "Activate Settings");
              if (!window.dxfSettingsPanel) {
                window.dxfSettingsPanel = new DxfSettingsPanel(window.viewer);
              }
              window.dxfSettingsPanel.show();
            },
            onDeactive: () => {
              console.log("[Toolbar]", "Deactivate Settings");
              if (!window.dxfSettingsPanel) {
                window.dxfSettingsPanel = new DxfSettingsPanel(window.viewer);
              }
              window.dxfSettingsPanel.hide();
            },
          },
          [ToolbarMenuId.Layers]: {
            onActive: () => {
              console.log("[Toolbar]", "Activate Layers");
              if (!window.layerManager) {
                window.layerManager = new LayerManagerPlugin(window.viewer);
              }
              window.layerManager.show();
            },
            onDeactive: () => {
              console.log("[Toolbar]", "Deactivate Layers");
              window.layerManager.hide();
            },
          },
        },
      };
      const viewer = new DxfViewer(config);
      const fontFiles = ["./demo/three/fonts/hztxt.shx", "./demo/three/fonts/simplex.shx"];
      await viewer.setFont(fontFiles);
      window.viewer = viewer;

      new AxisGizmoPlugin(viewer, { ignoreZAxis: true });
      new MeasurementPlugin(viewer);

      const toolbar = viewer.toolbar;
      toolbar.addMenu(
        "markup-screenshot",
        {
          menuName: "批注截屏",
          type: MenuTypeEnums.Switch,
          icon: {
            default: "icon-frame-clipping",
            active: "icon-frame-clipping",
          },
          onActive: () => {
            viewer.removeEventListener(ViewerEvent.PickMarkupDeactivated);
            viewer.addEventListener(ViewerEvent.PickMarkupDeactivated, () => {
              viewer.toolbar?.setActive("markup-screenshot", false);
            });
            viewer
              .getScreenshot(ScreenshotMode.PickMarkup)
              .then((result) => {
                console.log(
                  "[Toolbar] getScreenshot() returns:",
                  result?.base64Image
                );
                if (!result?.base64Image) {
                  throw "[Toolbar] Image data is empty!";
                }
                const a = document.createElement("a");
                a.href = result?.base64Image;
                a.download = "";
                a.click();
              })
              .catch((reason) => {
                console.error(
                  "[Toolbar] Failed to get screenshot, reason:",
                  reason
                );
              })
              .finally(() => {
                toolbar.setActive("markup-screenshot", false);
              });
          },
          mutexIds: [ToolbarMenuId.ZoomToRectangle, ToolbarMenuId.Screenshot],
        },
        [0, 5]
      );

      const onProgress = (event) => {
        const progress = ((event.loaded * 100) / event.total).toFixed(1);
        console.log(`[Demo] Loading progress: ${progress}%`);
      };
      viewer.loadModelAsync(modelCfg, onProgress).then(() => {
        console.log(`[Demo] Loaded model ${modelCfg.src}`);
      });

      const markupData = [
        {
          type: "ArrowMarkup",
          id: "c6ea70a3-ddb0-4dd0-87c8-bd2491936428",
          lineWidth: 2,
          lineColor: "#ff0000",
          fillColor: "#ff000030",
          layoutName: "Model",
          points: [
            [-15000, -9000],
            [-11000, -4000],
          ],
        },
        {
          type: "CloudRectMarkup",
          id: "82aba74f-7cd6-40e7-bac0-78d95a7bbecd",
          lineWidth: 2,
          lineColor: "#ff0000",
          fillColor: "#ff000030",
          layoutName: "Model",
          points: [
            [-7000, -1800],
            [-1000, -5000],
          ],
        },
        {
          type: "DotMarkup",
          id: "82aba74f-7cd6-40e7-bac0-78d95a7bbece",
          lineWidth: 2,
          lineColor: "#ff0000",
          fillColor: "#ff000030",
          layoutName: "Model",
          points: [[-7000, -8000]],
        },
      ];

      // viewer.setMarkups(markupData);
      viewer.addEventListener(ViewerEvent.LayoutChanged, () => {
        const layoutName = viewer.getActiveLayoutName();

        viewer.setMarkups(
          markupData.filter((markup) => markup.layoutName === layoutName)
        );
      });
    </script>
  </body>
</html>
